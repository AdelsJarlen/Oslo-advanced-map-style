
<!Doctype html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>Parkraumkarte Neukölln</title>
		<!-- Stylesheet defines map extent -->
		<style>
			body {
				padding: 0;
				margin: 0;
			}
			html,body, #map {
				height: 100%;
				font: Helvetica, Arial, sans-serif;
				font-size: 1.5vh;
				font-family: Helvetica, Arial, sans-serif;
				line-height: 150%;
			}
			.legend {
	    	position: absolute;
	    	line-height: 18px;
	    	color: #555;
	    	border-radius: 10px;
	    	background: rgba(255,255,255,0.8);
	    	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	    	border-radius: 5px;
	    	padding: 10px;
	    	width: 140px;
	    	font: 14px/16px Arial, Helvetica, sans-serif;
	    	line-height: 18px;
	    	color: #555;
			}
			.legend i {
				width: 18px;
				height: 18px;
				float: left;
				margin-right: 8px;
				opacity: 0.7;
			}
		</style>
		<!-- Stylesheet for Leafvar icons, fonts etc -->
		<link rel="stylesheet" href="css/leaflet.css"/>
	</head>

	<body>
		<div id="map"></div>
		<!--jquery - enables loading a GeoJson from a file directly into Leafvar -->
		<script src="javascript/jquery.min.js"></script>
		<script src="javascript/leaflet.js"></script>
		<script src="javascript/leaflet-hash.js"></script>

		<script>
			var options = {
				center: [52.48150, 13.43571],
				zoom: 18,
				minZoom: 15,
				maxZoom: 20,
				zoomControl: true,
				maxBounds: [[52.4557, 13.3985],[52.5005, 13.4863]]
			}

      // Create empty leaflet-map (named "map") on canvas with parameters defined in options
      var map = L.map("map", options);

			var parkingmap = L.tileLayer("https://supaplex.uber.space/map/tiles_parking/{z}/{x}/{y}.jpg", {
				name: 'parkingmap',
				maxZoom: 19,
				attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap-Mitwirkende</a>, Bordsteinkanten: OpenStreetMap und Geoportal Berlin / ALKIS. Datenstand: 15.01.2021'
			}).addTo(map);   // .addTo(map) loads this as the initial basemap

      var micromap = L.tileLayer("https://supaplex.uber.space/map/tiles/{z}/{x}/{y}.jpg", {
				name: 'micromap',
        maxZoom: 20,
        attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap-Mitwirkende</a>, Bordsteinkanten: OpenStreetMap und Geoportal Berlin / ALKIS. Datenstand: 15.01.2021'
      });

      var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				name: 'osm',
        maxZoom: 19,
        attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });

			var legend = L.control({ position: "bottomleft" });
			legend.onAdd = function (map) {
				var div = L.DomUtil.create("div", "legend");
				div.innerHTML += '<h4 style="margin:0 0 5px 0;">Legende</h4>';
				div.innerHTML += '<i style="background: #477AC2"></i>Water<br>';
				div.innerHTML += '<i style="background: #448D40"></i>Forest<br>';
				div.innerHTML += '<i style="background: #E6E696"></i>Land<br>';
				div.innerHTML += '<i style="background: #E8E6E0"></i>Residential<br>';
				div.innerHTML += '<i style="background: #FFFFFF"></i>Ice<br>';
				div.innerHTML += '<i class="icon" style="background-image: url(https://d30y9cdsu7xlg0.cloudfront.net/png/194515-200.png);background-repeat: no-repeat;"></i><span>Grænse</span><br>';
				div.innerHTML += '<hr>';
				div.innerHTML += '<a href="https://github.com/SupaplexOSM/parkraumkarte-neukoelln">Code auf GitHub</a>';

				return div;
			};
			legend.addTo(map);

			// map.on('zoomend', function (e) {
			// 	console.log(map.getZoom());
			// });
			map.on('moveend', function (e) {
				// console.log(map.getZoom());
				// map.removeControl(legend);
			});
			map.on('baselayerchange', function (e) {
				// console.log(e.layer.options.name, e.layer._url);
			});

      // name set of tilelayers and adds them to the layer-selector
      var baseMaps = {
        "Straßenraumkarte": micromap,
        "Parkraumkarte": parkingmap,
        "OpenStreetMap": osm
      };

      // define and add control menu
      L.control.layers(baseMaps,null,{collapsed:false}).addTo(map);

      var hash = new L.Hash(map, baseMaps);

			// ?map-Param: Helper: newUrl
			const mapParamNewURL = function(layer_name) {
				return window.location.protocol + "//" + window.location.host + window.location.pathname + '?map=' + layer_name + window.location.hash;
			}

			// ?map-Param: Helper: mapLayer from ?map-Param
			// (this will only work for just one param)
			const mapLayerNameFromURLParam = function() {
				return window.location.search.substr(1).split('=')[1]
			}

			// ?map-Param: On load, if no ?map-Param present, add one
			if (window.location.search.substr(1) === '') {
				let newurl = mapParamNewURL('parkingmap')
				history.replaceState({ path: newurl }, '', newurl);
			}

			// ?map-Param: On load, if ?map-Param present, set Layer to ?map-Param
			const mapParamSetMapLayerBasedOnMapParam = function (map, baseMaps) {
				let currentLayer = map._layers
				let paramLayerName = mapLayerNameFromURLParam()
				let paramLayer = {}
				let layersToBeRemoved = []

				Object.keys(baseMaps).map((layer_key, index) => {
					var layer = baseMaps[layer_key]
					if (layer.options.name === paramLayerName) {
						paramLayer = layer
					} else {
						layersToBeRemoved[index] = layer
					}
				})

				layersToBeRemoved.forEach( function(layer) {
					map.removeLayer(layer)
				})
				map.addLayer(paramLayer)
			}
			mapParamSetMapLayerBasedOnMapParam(map, baseMaps)

			// ?map-Param: Whenever the layer is changed, update the URL (and keep the leaflet-hash)
			const mapParamOnMapMoveOrLayerChange = function (event) {
				let newurl = mapParamNewURL(event.layer.options.name)
				history.pushState({ path: newurl }, '', newurl);
			}
			map.on('baselayerchange', mapParamOnMapMoveOrLayerChange);
		</script>
	</body>
</html>
